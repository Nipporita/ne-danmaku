"""Satori 弹幕客户端"""
# 本模块用于连接 Satori 平台，并将收到的弹幕转发到本地弹幕系统

from satori.client import App, WebsocketsInfo, EventType, Account
# App：Satori 客户端主对象
# WebsocketsInfo：WebSocket 连接信息
# EventType：事件类型枚举（如消息创建）
# Account：账号信息

from satori.event import MessageEvent
# MessageEvent：消息事件对象

from satori.element import Text
# Text：消息中的文本元素（Satori 的消息是“元素列表”）

from launart import Launart
# Launart：异步组件生命周期管理框架（Satori 官方推荐）

from graia.amnesia.builtins.aiohttp import AiohttpClientService
# Aiohttp 客户端服务，用于 WebSocket / HTTP 底层通信

from asyncio import create_task, Task
import regex
from loguru import logger

from ..config import SatoriConfig
# Satori 的配置结构

from .models import ConnectionManager, DanmakuMessage
from .DanmakuClass.DanmakuBuilder import DanmakuBuilder
# ConnectionManager：本地弹幕连接管理器
# DanmakuMessage：统一的弹幕消息数据结构


# =========================
# 全局状态（确保只启动一个客户端）
# =========================

satori_task: Task | None = None
# Satori 客户端运行的 asyncio 任务

launart: Launart | None = None
# Launart 实例，用于管理客户端生命周期


async def start_satori_client(
    config: SatoriConfig,
    connection_manager: ConnectionManager,
) -> Task:
    """启动 Satori 客户端
    
    Args:
        config: Satori 配置
        connection_manager: 弹幕连接管理器（用于广播弹幕）
        
    Returns:
        Task: Satori 客户端对应的 asyncio 任务
    """
    global satori_task, launart

    # 如果已经启动过客户端，则直接复用
    if satori_task is not None:
        logger.warning("Satori 客户端已经在运行")
        return satori_task

    # 创建 Launart 生命周期管理器
    launart = Launart()

    # 创建 Satori 客户端实例
    client = App(
        WebsocketsInfo(
            host=config.host,
            port=config.port,
            path=config.path,
            token=config.token,
        )
    )

    # =========================
    # 注册消息事件处理器 （需要大改）
    # =========================

    @client.register_on(EventType.MESSAGE_CREATED)
    async def handle_message(account: Account, event: MessageEvent):
        # 收到一条新消息（弹幕）

        # 如果该频道未在配置的 group_map 中，直接忽略
        if event.channel.id not in config.group_map:
            logger.warning(
                "收到未配置频道的弹幕，频道 ID: {}",
                event.channel.id,
            )
            return

        # 将 Satori 频道 ID 映射为本地弹幕分组
        danmaku_channel = config.group_map[event.channel.id]

        # 获取发送者用户 ID
        userid = event.user.id
        
        # 尝试获取用户名（优先级：成员昵称 > 用户昵称 > 用户名）
        username = (
            event.member.nick
            or event.user.nick
            or event.user.name
            or "匿名"
        )

        # 消息内容是“元素列表”
        elements = event.message.message

        logger.debug(
            "收到弹幕，频道: {}, 用户: {}-{}, 内容: {}",
            danmaku_channel,
            userid,
            username,
            elements,
        )

        # 使用 DanmakuMessage 的工厂方法构造消息对象
        danmaku = DanmakuBuilder.create(
            senderId=str(userid),
            sender=username,
            elements=elements,
        )

        if danmaku is None:
            logger.warning(
                "无法构建弹幕消息，频道: {}, 用户: {}-{}, 内容: {}",
                danmaku_channel,
                userid,
                username,
                elements,
            )
            return
        else:
            logger.debug(
                "构建弹幕消息成功，频道: {}, 用户: {}-{}, 弹幕对象: {}",
                danmaku_channel,
                userid,
                username,
                danmaku,
            )
        
        # 将弹幕广播到对应分组的所有连接
        await connection_manager.broadcast_to_group(
            danmaku_channel,
            danmaku,
        )

    # =========================
    # 启动 Launart 组件
    # =========================

    # 添加 aiohttp 客户端服务（底层网络支持）
    launart.add_component(AiohttpClientService())

    # 添加 Satori 客户端组件
    launart.add_component(client)

    # 启动 Launart，并将其作为一个 asyncio 任务运行
    satori_task = create_task(
        launart.launch(),
        name="satori",
    )

    logger.info("Satori 客户端正在启动")

    return satori_task


async def stop_satori_client():
    """停止 Satori 客户端"""
    global satori_task, launart

    # # 清理全局状态
    # satori_task = None
    # launart = None
    
    # logger.info("Satori 客户端已停止（真实停止不在此log）")
    
    # 如果客户端正在运行，则触发关闭流程
    if satori_task is not None and launart is not None:
        # 向 Launart 发送系统信号，触发组件优雅退出
        launart._on_sys_signal(
            None,
            None,
            main_task=satori_task,
        )

        # 等待任务结束
        await satori_task

        # 清理全局状态
        satori_task = None
        launart = None

        logger.info("Satori 客户端已停止")
